name: SF(DX) Scanner

on:
  workflow_call:

jobs:
  prepare-scan:
    runs-on: ubuntu-latest
    name: "Prepare and initiate scan"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: Szandor72/devops-center-actions/.github/install-tooling@main

      - name: "Fetch all Files and prepare scan"
        run: |
          git fetch --all
          node ./scripts/ci/prepare-scan.js

      - name: "Install Salesforce CLI"
        run: |
          npm install @salesforce/cli --location=global

      - name: "Install plugin"
        run: |
          sf plugins install @salesforce/sfdx-scanner
      - name: "Run Legacy Scan on modified legacy files"
        run: |
          sf scanner run --target ./legacy-metadata/ \
            --engine "pmd,eslint-lwc,retire-js" \
            --category "Security,Performance,problem,Insecure Dependencies" \
            --normalize-severity \ 
            --format json \
            --outfile scan-results.json

      - name: Upload scan results
        uses: actions/upload-artifact@v3
        with:
          name: scan-results
          path: scan-results.json

      - name: "Run Strict Scan on other files"
        run: |
          sf scanner run --target ./force-app/ \
            --normalize-severity \
            --severity-threshold 3
